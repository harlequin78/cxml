<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>Closure XML</title>
    <style type="text/css">
      body { 
        color: #000000;
        background-color: #ffffff;
        margin-bottom: 10%;
      }
      pre {
        background-color: #eeeeee;
        border: solid 1px #d0d0d0;
        padding: 1em;
        margin-right: 10%;
      }
      .def {
        background-color: #ddddff;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Closure XML Parser</h1>

    <p>An XML parser written in Common Lisp.</p>

    <p>
      Closure XML was written by <a
      href="http://www.stud.uni-karlsruhe.de/~unk6/">Gilbert Baumann</a>
      (unk6 at rz.uni-karlsruhe.de) as part of the Closure web
      browser.<br/>
      Contributions to the parser by
    </p>
    <ul>
      <li>
        Henrik Motakef (hmot at henrik-motakef.de)<br/>
        (SAX layer; namespace support)
      </li>
      <li>
        David Lichteblau at knowledgeTools (david at knowledgetools.de)<br/>
        (conversion into an independent package; DOM bug fixing)
      </li>
    </ul>

    <p>
      Mailing list <a
      href="http://common-lisp.net/mailman/listinfo/cxml-devel">cxml-devel</a>
      is hosted on common-lisp.net.
    </p>

    <p><b>Download.</b></p>
    <p>
      There is no CVS repository (yet).<br/>
      You can check out David's tla archive at <a
      href="http://www.common-lisp.net/project/cxml/david@knowledgetools.de--cxml/">http://www.common-lisp.net/project/cxml/david@knowledgetools.de--cxml/</a>.<br/>
      There will also be <a href="http://www.common-lisp.net/project/cxml/download/">tarballs</a>.
    </p>
    <p>
      (Brief tla usage instructions: Unpack the cxml tarball.&nbsp;
      Enter <tt>tla register-archive URL</tt> to turn it into a working
      copy.&nbsp; <tt>tla update</tt> is similar to <tt>cvs up</tt>.)
    </p>

    <p>
      <b>Contents</b>
    </p>
    <ul>
      <li><a href="#modules">CXML modules</a></li>
      <li><a href="#installation">Installation</a></li>
      <li><a href="#tests">Tests</a></li>
      <li><a href="#todo">To do</a></li>
      <li><a href="#using">Using the parser</a></li>
      <li><a href="#sax">SAX interface</a></li>
      <li><a href="#dom">DOM notes</a></li>
    </ul>

    <p>
      <b>Changes</b>
    </p>
    <ul>
      <li>Renamed package <tt>XML</tt> to <tt>CXML</tt>.</li>
      <li>The unparse functions support non-canonical output now.</li>
    </ul>

    <a name="modules"/>
    <h2>CXML Modules</h2>
    <p>CXML provides three packages:</p>
    <ul>
      <li>
        <tt>RUNES</tt>, a portable implementation of Unicode strings.
      </li>
      <li>
        <tt>CXML</tt>, a namespace-aware SAX parser implementing the <a
        href="http://www.w3.org/TR/2000/REC-xml-20001006">XML 1.0
        specification</a>.
      </li> 
      <li>
        <tt>DOM</tt>, an implementation of the <a
        href="http://www.w3.org/TR/REC-DOM-Level-1/level-one-core.html">DOM
        Level 1 Core</a> interfaces.
      </li>
    </ul>

    <a name="installation"/>
    <h2>Installation</h2>
    <p>
      CXML is written in Common Lisp and should be portable to all
      Common Lisp implementations.&nbsp; Currently known to work are
      ACL, SBCL, CMUCL, and CLISP.  (CLISP needs some <tt>-E</tt> option
      teaching it to accept non-ASCII source files.)
    </p>

    <p>
      <a href="http://www.cliki.net/asdf">ASDF</a> is used for
      compilation.  The following instructions assume that ASDF has
      already been loaded.
    </p>

    <p>
      <b>Configuration (optional).</b>
      CXML has full Unicode code support -- even on Lisps without
      Unicode strings.  On non-unicode aware Lisps, <tt>DOMString</tt>
      is implemented as an array of character codes.  If your Lisp
      supports 16 bit characters natively, you can enable feature
      <tt>RUNE-IS-CHARACTER</tt> to select an alternative
      <tt>DOMString</tt> implementatation, which uses real characters
      instead of characters codes.
    </p>
    <pre>* (pushnew :rune-is-character *features*)</pre>

    <p>
      <b>Compiling and loading CXML.</b>
      Register the .asd file, e.g. by symlinking it:
    </p>
    <pre>$ ln -sf `pwd`/cxms.asd /path/to/your/registry</pre>
    <p>Then compile CXML using:</p>
    <pre>* (asdf:operate 'asdf:load-op :cxml)</pre>

    <a name="tests"/>
    <h2>Tests</h2>
    <p>Check out the XML and DOM testsuites:</p>
    <pre>$ export CVSROOT=:pserver:anonymous@dev.w3.org:/sources/public
$ cvs login    # password is "anonymous"
$ cvs co 2001/XML-Test-Suite/xmlconf
$ cvs co 2001/DOM-Test-Suite</pre>
    <p>Usage and expected output:</p>
    <pre>* (xmlconf:run-all-tests "/path/to/2001/XML-Test-Suite/xmlconf/")
7/389 tests failed; 1773 tests were skipped
* (domtest:run-all-tests "/path/to/2001/DOM-Test-Suite/")
0/440 tests failed; 81 tests were skipped</pre>

    <p>
      <i>fixme</i>: Add an explanation of xml/sax-tests here.
    </p>

    <p>
      <b>fixme</b> My parser does not understand the current testsuite
      anymore.&nbsp; To fix this problem, revert the affected files
      manually after check-out:
    </p>

    <pre>$ cd 2001/XML-Test-Suite/xmlconf/
xmltest$ patch -p0 -R &lt;/path/to/cxml/test/xmlconf-base.diff</pre>

    <p>
      The log message for the changes reads "<i>Removed unnecessary
      xml:base attribute</i>".&nbsp; If I understand correctly, only
      DOM&nbsp;3 parsers provide the baseURI attribute necessary for
      understanding <tt>xmlconf.xml</tt> now.&nbsp; We don't have that
      yet.
    </p>

    <a name="todo"/>
    <h2>To do</h2>
    <ul>
      <li>
        David's changes might have affected performance.&nbsp; Some
        benchmarking needs to be done here.
      </li>
      <li>
        DOM in general is pretty heavyweight.&nbsp; There is/was a
        "simple-dom" which should be faster.&nbsp; This might be worth
        reviving.
      </li>
      <li>
        For those who don't like DOM at all, it would be a very simple
        exercise to write a SAX handler for "Lisp-XML" output instead of
        DOM.&nbsp; Other ideas include Erik Naggum's <a
        href="http://groups.google.com/groups?hl=en&amp;lr=&amp;ie=UTF-8&amp;selm=3283503882585065KL2065E_-_%40naggum.no">quad</a>s.
      </li>
      <li>
        The serializer supports only <a
        href="http://www.w3.org/TR/2001/REC-xml-c14n-20010315">Canonical
        XML</a> right now.&nbsp; In the future we want support for:
        Including doctype declarations in the output, <strike>ordinary output
        with less character reference noise</strike> (done), <strike>optional
        indentation</strike> (done), user-specified encoding, etc.
      </li>
      <li>
        There are still thread-safety issues.
      </li>
      <li>
        Validation!
      </li>
    </ul>
    <p>
      (Compare also with Gilbert Baumann's older TODO list in
      <tt>xml-parse.lisp</tt>.)
    </p>

    <a name="using"/>
    <h2>Using the parser</h2>
    <p>
      <div class="def">Function CXML:PARSE-FILE (pathname handler)</div>
      <div class="def">Function CXML:PARSE-STREAM (stream handler)</div>
      <div class="def">Function CXML:PARSE-OCTETS (octets handler)</div>
      Parse a CXML document.&nbsp; Arguments:
    </p>
    <ul>
      <li><tt>pathname</tt> -- a Common Lisp pathname</li>
      <li><tt>stream</tt> -- a Common Lisp stream with element-type
        <tt>(unsigned-byte 8)</tt></li>
      <li><tt>octets</tt> -- an <tt>(unsigned-byte 8)</tt> array</li>
      <li><tt>handler</tt> -- a SAX handler</li>
    </ul>
    <p>Return values from this function depend on the SAX handler used.</p>

    <p>
      <div class="def">Function DOM:MAKE-DOM-BUILDER ()</div>
      Create a SAX handler which builds a DOM document.&nbsp; Example:
    </p>
    <pre>(cxml:parse-file "test.xml" (dom:make-dom-builder))</pre>

    <p>
      <div class="def">Function CXML:UNPARSE-DOCUMENT (document stream &rest keys)</div>
      <div class="def">Function CXML:UNPARSE-DOCUMENT-TO-OCTETS (document &rest keys) => vector</div>
      Serialize a DOM document object.
    </p>
    <ul>
      <li><tt>document</tt> -- a DOM document object</li>
      <li><tt>stream</tt> -- a Common Lisp stream with element-type
        <tt>character</tt></li>
    </ul>
    <p>Keyword arguments:</p>
    <ul>
      <li>
        <tt>canonical</tt> -- canonical form, one of NIL, T, 1, 2
      </li>
      <li>
        <tt>indentation</tt> -- indentation level.  An integer or <tt>nil</tt>.
      </li>
    </ul>
    <p>
      The following <tt>canonical</tt> values are allowed:
    </p>
    <ul>
      <li>
        <tt>t</tt> or <tt>1</tt>: <a
         href="http://www.w3.org/TR/2001/REC-xml-c14n-20010315">Canonical
         XML</a>
      </li>
      <li>
        <tt>2</tt>: <a
         href="http://dev.w3.org/cvsweb/~checkout~/2001/XML-Test-Suite/xmlconf/sun/cxml.html?content-type=text/html;%20charset=iso-8859-1">Second
         Canonical Form</a>
      </li>
      <li>
        <tt>NIL</tt>: Use a more readable non-canonical representation.
      </li>
    </ul>
    <p>
      With an <tt>indentation</tt> level, pretty-print the XML by
      inserting additional whitespace.&nbsp; Note that indentation
      changes the document model and should only be used if whitespace
      does not matter to the application.
    </p>
    <p>
      <tt>unparse-document-to-octets</tt> returns an <tt>(unsigned-byte
      8)</tt> array, whereas <tt>unparse-document</tt> writes
      characters.&nbsp; <tt>unparse-document</tt> is useful together
      with <tt>with-output-to-string</tt>.&nbsp; However, note that the
      resulting document in both cases is UTF-8 encoded, so the
      characters written by <tt>unparse-document</tt> are really UTF-8
      bytes encoded as characters.
    </p>

    <a name="sax"/>
    <h2>SAX interface</h2>
    <p>
      A SAX handler is an arbitrary objects that implements some of the
      generic functions in the SAX package.&nbsp; Note that no default
      handler class is necessary, because all generic functions have default
      methods which do nothing.&nbsp; SAX functions are:
      <div class="def">Function SAX:START-DOCUMENT (handler)</div>
      <div class="def">Function SAX:START-ELEMENT (handler namespace-uri local-name qname attributes)</div>
      <div class="def">Function SAX:START-PREFIX-MAPPING (handler prefix uri)</div>
      <div class="def">Function SAX:CHARACTERS (handler data)</div>
      <div class="def">Function SAX:PROCESSING-INSTRUCTION (handler target data)</div>
      <div class="def">Function SAX:END-PREFIX-MAPPING (handler prefix)</div>
      <div class="def">Function SAX:END-ELEMENT (handler namespace-uri local-name qname attributes)</div>
      <div class="def">Function SAX:END-DOCUMENT (handler)</div>
      <div class="def">Function SAX:COMMENT (handler data)</div>
      <div class="def">Function SAX:START-CDATA (handler)</div>
      <div class="def">Function SAX:END-CDATA (handler)</div>
      <div class="def">Function SAX:START-DTD (handler name public-id system-id)</div>
      <div class="def">Function SAX:END-DTD (handler)</div>
    </p>
    <p>
      <i>fixme</i>: For information on these functions refer to the docstrings.
    </p>
    <p>
      <i>fixme</i>: Entity and notation processing isn't quite right yet.
    </p>


    <a name="dom"/>
    <h2>DOM Notes</h2>
    <p>
      CXML implements the DOM Level 1 Core interfaces.&nbsp; Explaining
      DOM is better left to the <a
      href="http://www.w3.org/TR/REC-DOM-Level-1/level-one-core.html">specification</a>,
      so please refer to the official W3C documents for DOM.
    </p>
    <p>
      However, there is no "standard" DOM mapping for Lisp.&nbsp; DOM
      is <a
      href="http://www.w3.org/TR/REC-DOM-Level-1/idl-definitions.html">specified
      in CORBA IDL</a>, but it refrains from using object-oriented IDL
      features, allowing for a much more natural Lisp implemenation than
      the the ordinary IDL/Lisp mapping would.
    </p>
    <p>
      Differences between CXML's DOM and the direct IDL/Lisp mapping:
    </p>
    <ul>
      <li>
        DOM function names are symbols in the <tt>DOM</tt> package (not
        the <tt>OP</tt> package).
      </li>
      <li>
        DOM functions have proper required arguments, not a huge
        <tt>&rest</tt> lambda list.
      </li>
      <li>
        Although most IDL interfaces are implemented as CLOS classes by
        CXML, the Lisp types of DOM objects is not documented and cannot
        be relied upon.&nbsp; A node's type can be determined using
        <tt>dom:node-type</tt> instead.
      </li>
      <li>
        <tt>DOMString</tt> is mapped to <tt>rod</tt>, which is either
        an <tt>(unsigned-byte 16)</tt> array type or a string type.
      </li>
      <li>
        The IDL/Lisp mapping maps CORBA enums to Lisp keywords.&nbsp;
        Unfortunately, the DOM IDL does not use enums.&nbsp; Instead,
        both exception types and node types are defined integer
        constants.&nbsp; CXML chooses to ignore this definition and uses
        keywords instead.
      </li>
      <li>
        DOM uses StudlyCaps.&nbsp; Lisp programmers don't.&nbsp; We
        insert <tt>#\-</tt> before every upper case letter preceded by a
        lower case letter and before every upper case letter which is
        followed by a lower case letter, but preceded by a capital
        letter.&nbsp; This algorithms leads to the natural Lisp spelling
        of DOM function names.
      </li>
      <li>
        Implementation note: DOM's <tt>NodeList</tt> does not
        necessarily map to a native "sequence" type.&nbsp; (For example,
        node lists are objects in Java, not arrays.)&nbsp;
        <tt>NodeList</tt> is specified to reflect changes done after a
        node list was created, so node lists cannot be Lisp lists.&nbsp;
        (A node list could be implemented as a CLOS object pointing to
        said list though.)&nbsp; Instead, CXML currently implements node
        lists as adjustable vectors.&nbsp; Note that code which relies on
        this implementation and uses Lisp sequence functions
        instead of sticking to <tt>dom:item</tt> and <tt>dom:length</tt>
        is not portable.&nbsp; As a compromise, you can use our
        extensions <tt>dom:map-node-list</tt> or
        <tt>dom:do-node-list</tt>, which can be implemented portably.
      </li>
    </ul>
    <p>Example:</p>
    <pre>XML(97): (dom:node-type
          (dom:document-element
           (cxml:parse-file "~/test.xml" (dom:make-dom-builder))))
:ELEMENT</pre>
  </body>
</html>
