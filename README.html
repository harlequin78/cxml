<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>Closure XML</title>
    <style type="text/css">
      body { 
        color: #000000;
        background-color: #ffffff;
        margin-bottom: 10%;
      }
      pre {
        background-color: #eeeeee;
        border: solid 1px #d0d0d0;
        padding: 1em;
        margin-right: 10%;
      }
      .def {
        background-color: #ddddff;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Closure XML Parser</h1>

    <p>An XML parser written in Common Lisp.</p>

    <p>
      Closure XML was written by <a
      href="http://www.stud.uni-karlsruhe.de/~unk6/">Gilbert Baumann</a>
      (unk6 at rz.uni-karlsruhe.de) as part of the Closure web
      browser.<br/>
      Contributions to the parser by
    </p>
    <ul>
      <li>
        Henrik Motakef (hmot at henrik-motakef.de)<br/>
        (SAX layer; namespace support)
      </li>
      <li>
        David Lichteblau at knowledgeTools (david at knowledgetools.de)<br/>
        (conversion into an independent package; DOM bug fixing)
      </li>
    </ul>

    <p>
      <b>Contents</b>
    </p>
    <ul>
      <li><a href="#modules">CXML modules</a></li>
      <li><a href="#installation">Installation</a></li>
      <li><a href="#tests">Tests</a></li>
      <li><a href="#todo">To do</a></li>
      <li><a href="#using">Using the parser</a></li>
    </ul>

    <a name="modules"/>
    <h2>CXML Modules</h2>
    <p>CXML provides three packages:</p>
    <ul>
      <li>
        <tt>RUNES</tt>, a portable implementation of Unicode strings.
      </li>
      <li>
        <tt>XML</tt>, a namespace-aware SAX parser implementing the <a
        href="http://www.w3.org/TR/2000/REC-xml-20001006">XML 1.0
        specification</a>.
      </li> 
      <li>
        <tt>DOM</tt>, an implementation of the <a
        href="http://www.w3.org/TR/REC-DOM-Level-1/level-one-core.html">DOM
        Level 1 Core</a> interfaces.
      </li>
    </ul>

    <a name="installation"/>
    <h2>Installation</h2>
    <p>
      CXML is written in Common Lisp and should be portable to all
      Common Lisp implementations.&nbsp; Currently known to work are
      ACL, SBCL, CMUCL, and CLISP.  (CLISP needs some <tt>-E</tt> option
      teaching it to accept non-ASCII source files.)
    </p>

    <p>
      <a href="http://www.cliki.net/asdf">ASDF</a> is used for
      compilation.  The following instructions assume that ASDF has
      already been loaded.
    </p>

    <p>
      <b>Configuration (optional).</b>
      CXML has full Unicode code support -- even on Lisps without
      Unicode strings.  On non-unicode aware Lisps, <tt>DOMString</tt>
      is implemented as an array of character codes.  If your Lisp
      supports 16 bit characters natively, you can enable feature
      <tt>RUNE-IS-CHARACTER</tt> to select an alternative
      <tt>DOMString</tt> implementatation, which uses real characters
      instead of characters codes.
    </p>
    <pre>* (pushnew :rune-is-character *features*)</pre>

    <p>
      <b>Compiling and loading CXML.</b>
      Register the .asd file, e.g. by symlinking it:
    </p>
    <pre>$ ln -sf `pwd`/cxms.asd /path/to/your/registry</pre>
    <p>Then compile CXML using:</p>
    <pre>* (asdf:operate 'asdf:load-op :cxml)</pre>

    <a name="tests"/>
    <h2>Tests</h2>
    <p>Check out the XML and DOM testsuites:</p>
    <pre>$ export CVSROOT=:pserver:anonymous@dev.w3.org:/sources/public
$ cvs login    # password is "anonymous"
$ cvs co 2001/XML-Test-Suite/xmlconf
$ cvs co 2001/DOM-Test-Suite</pre>
    <p>Usage and expected output:</p>
    <pre>* (xmlconf:run-all-tests "/path/to/2001/XML-Test-Suite/xmlconf/")
22/389 tests failed; 1773 tests were skipped
* (domtest:run-all-tests "/path/to/2001/2001/DOM-Test-Suite/")
0/440 tests failed; 81 tests were skipped</pre>

    <p>
      Most XML testsuite failures are due to document type declarations
      which are read by CXML, but not written when the document is
      serialized again.&nbsp; This needs work.
    </p>

    <p>
      <i>fixme</i>: Add an explanation of xml/sax-tests here.
    </p>

    <p>
      <b>fixme</b> My parser does not understand the current testsuite
      anymore.&nbsp; To fix this problem, revert the affected files
      manually after check-out:
    </p>

    <pre>$ cd 2001/XML-Test-Suite/xmlconf/
xmltest$ patch -p0 -R &lt;/path/to/cxml/test/xmlconf-base.diff</pre>

    <p>
      The log message for the changes reads "<i>Removed unnecessary
      xml:base attribute</i>".&nbsp; If I understand correctly, only
      DOM&nbsp;3 parsers provide the baseURI attribute necessary for
      understanding <tt>xmlconf.xml</tt> now.&nbsp; We don't have that
      yet.
    </p>

    <a name="todo"/>
    <h2>To do</h2>
    <ul>
      <li>
        David's changes might have affected performance.&nbsp; Some
        benchmarking needs to be done here.
      </li>
      <li>
        DOM in general is pretty heavyweight.&nbsp; There is/was a
        "simple-dom" which should be faster.&nbsp; This might be worth
        reviving.
      </li>
      <li>
        For those who don't like DOM at all, it would be a very simple
        exercise to write a SAX handler for "Lisp-XML" output instead of
        DOM.&nbsp; Other ideas include Erik Naggum's <a
        href="http://groups.google.com/groups?hl=en&amp;lr=&amp;ie=UTF-8&amp;selm=3283503882585065KL2065E_-_%40naggum.no">quad</a>s.
      </li>
      <li>
        The serializer supports only <a
        href="http://www.w3.org/TR/2001/REC-xml-c14n-20010315">Canonical
        XML</a> right now.&nbsp; In the future we want support for:
        Including doctype declarations in the output, ordinary output
        with less entity noise, optional indentation, etc.
      </li>
      <li>
        There are still thread-safety issues.
      </li>
      <li>
        Validation!
      </li>
    </ul>

    <a name="using"/>
    <h2>Using the parser</h2>
    <p>
      <div class="def">Function XML:PARSE-FILE (pathname handler)</div>
      <div class="def">Function XML:PARSE-STREAM (stream handler)</div>
      <div class="def">Function XML:PARSE-OCTETS (octets handler)</div>
      Parse an XML document.&nbsp; Arguments:
    </p>
    <ul>
      <li><tt>pathname</tt> -- a Common Lisp pathname</li>
      <li><tt>stream</tt> -- a Common Lisp stream with element-type
        <tt>(unsigned-byte 8)</tt></li>
      <li><tt>octets</tt> -- an <tt>(unsigned-byte 8)</tt> array</li>
      <li><tt>handler</tt> -- a SAX handler</li>
    </ul>
    <p>Return values from this function depend on the SAX handler used.</p>

    <p>
      <div class="def">Function DOM:MAKE-DOM-BUILDER ()</div>
      Create a SAX handler which builds a DOM document.&nbsp; Example:
    </p>
    <pre>(xml:parse-file "test.xml" (dom:make-dom-builder))</pre>
  </body>
</html>
